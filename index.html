<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Secure Payment Setup</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 500px; margin: auto; }
    #card-element { padding: 10px; border: 1px solid #ccc; border-radius: 6px; margin-bottom: 12px; }
    button { padding: 10px 20px; font-size: 16px; }
    #result-message { margin-top: 12px; }
  </style>
</head>
<body>
  <h2>Enter Your Card Details</h2>
  <div id="auth-status">Authenticating...</div>

  <form id="payment-form" style="display:none;">
    <div id="card-element"></div>
    <button type="submit">Save Payment Method</button>
    <div id="result-message"></div>
  </form>

<script>
  const stripe = Stripe("pk_test_51RDmCP4eAi3CoBPgCCKylfq60XZxTp7X44vvqSm3hygIhGW7gRHqfLKojXEgnWzGmz2eFh6qyTHGVk43gXbBE7Hp007gTqtMMN");
  const supabase = createClient("https://jtrenbwpefzevqlkcfly.supabase.co", "your-supabase-public-anon-key");

  async function authenticateAndSetup() {
    const token = new URLSearchParams(window.location.search).get("token");
    console.log("Access Token:", token);

    if (!token) {
      document.getElementById('auth-status').innerText = "❌ No token in URL";
      return;
    }

    const { data: { user }, error } = await supabase.auth.getUser(token);
    if (error || !user) {
      console.error("Supabase auth error:", error);
      document.getElementById('auth-status').innerText = "❌ Invalid token or failed auth";
      return;
    }

    const email = user.email;
    document.getElementById('auth-status').innerText = `✅ Signed in as ${email}`;

    // 1. Create Stripe SetupIntent via Edge Function
    const res = await fetch("https://jtrenbwpefzevqlkcfly.supabase.co/functions/v1/create-stripe-customer", {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${token}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ email: email, name: "" })
    });

    const data = await res.json();
    if (!res.ok) {
      document.getElementById('auth-status').innerText = `❌ SetupIntent error: ${data.error}`;
      return;
    }

    const clientSecret = data.setup_intent_client_secret;
    const elements = stripe.elements();
    const card = elements.create('card');
    card.mount('#card-element');

    document.getElementById('payment-form').style.display = 'block';

    document.getElementById('payment-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const { setupIntent, error } = await stripe.confirmCardSetup(clientSecret, {
        payment_method: { card }
      });

      if (error) {
        document.getElementById('result-message').innerText = `⚠️ ${error.message}`;
      } else {
        document.getElementById('result-message').innerText = "✅ Card saved!";

        await fetch("https://jtrenbwpefzevqlkcfly.supabase.co/functions/v1/save-payment-method", {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ payment_method_id: setupIntent.payment_method })
        });

        if (window.Flutter) {
          Flutter.postMessage("payment_setup_complete");
        }
      }
    });
  }

  authenticateAndSetup();
</script>
</body>
</html>
